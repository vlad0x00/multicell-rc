#!/usr/bin/env python3

import seaborn as sns
import matplotlib.pyplot as plt
import sys
import numpy as np
import pandas as pd
import math
import os
import utils
sns.set(font_scale=1.1)

data = { 'Cells' : [], 'Cell types' : [], 'Cytokines' : [], 'Lambda' : [], 'Threshold' : [], 'Secretion' : [], 'Cell radius' : [], 'If grid spacing' : [], 'Window' : [], 'Accuracy': [], 'Cells with correct signal' : [] }
for dirpath, dirnames, filenames in os.walk('results/'):
  for filename in filenames:
    if os.path.basename(filename) == 'stdout':
      with open(os.path.join(dirpath, filename), 'r') as f:
        params_found = False
        accuracy_found = False
        for line in f:
          if line.startswith('PARAMS:'):
            tokens = line.split()[1:]
            args = utils.parse_args(tokens)

            data['Cells'].append(args.cells)
            data['Cell types'].append(args.cell_types)
            data['Cytokines'].append(str(args.cytokines) + " cytokines")
            data['Lambda'].append("Lambda = " + str(round(math.sqrt(5.0 / args.alpha))) + ", Alpha = " + str(args.alpha))
            data['Threshold'].append(args.cytokine_threshold)
            data['Secretion'].append(args.secretion_high)
            data['Cell radius'].append(args.cell_radius)
            data['If grid spacing'].append(args.grid_spacing)
            data['Window'].append(args.window_size)

            params_found = True
          if line.startswith('Testing accuracy:'):
            data['Accuracy'].append(float(line.split()[2]))
            accuracy_found = True

          if line.startswith("Cells with correct input signal:"):
            tokens = line.split(":")[1].split("/")
            data['Cells with correct signal'].append(float(tokens[0]) / float(tokens[1]))

        assert params_found and accuracy_found

print("Average fraction of cells with correct input signal:", sum(data['Cells with correct signal']) / len(data['Cells with correct signal']))

pd.DataFrame(data).to_csv('results.csv')