#!/bin/bash

if [[ $# -ne 1 || ($1 != "ltss" && $1 != "ccc") ]]; then
  echo "Must provide type of test: ltss (lambda/threshold/secretion/spacing) or ccc (cells/cell types/cytokines)."
  exit 1
fi

# Lambda = sqrt(Beta / Alpha)
# Beta = 5
# Alpha = Beta / (Lambda ^ 2)

if [[ $1 == "ltss" ]]; then
  CELLS=( 216 )
  CELL_TYPES=( 12 )
  CYTOKINES=( 2 )
  LAMBDAS=( 3 5 7 9 11 )
  THRESHOLDS=( 0.01 0.05 0.1 0.5 1.0 1.5 2.0 2.5 4.0 )
  SECRETIONS_HIGH=( 0.1 0.5 1 5 10 20 40 60 120 )
  CELL_RADIUSES=( 1 )
  IF_GRID_SPACINGS=( 2.3 2.5 2.7 )
  WINDOWS=( 5 )
else
  CELLS=( 50 100 200 400 )
  CELL_TYPES=( 1 10 25 50 )
  CYTOKINES=( 0 1 2 3 4 5 )
  LAMBDAS=( 3 )
  THRESHOLDS=( 2.0 )
  SECRETIONS_HIGH=( 50 )
  CELL_RADIUSES=( 1 )
  IF_GRID_SPACINGS=( 2.5 )
  WINDOWS=( 5 )
fi

ITERATIONS=30

cd "$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
cd ..

params_sets=()
iterations=()
for cells in ${CELLS[@]}; do
for cell_types in ${CELL_TYPES[@]}; do
for cytokines in ${CYTOKINES[@]}; do
for lambda in ${LAMBDAS[@]}; do
alpha=$(bc <<< "scale=2; 5 / ($lambda ^ 2)")
for threshold in ${THRESHOLDS[@]}; do
for secretion_high in ${SECRETIONS_HIGH[@]}; do
for cell_radius in ${CELL_RADIUSES[@]}; do
for if_grid_spacing in ${IF_GRID_SPACINGS[@]}; do
for window in ${WINDOWS[@]}; do
for iteration in $(seq $ITERATIONS); do
  params_sets+=("-c $cells -p $cell_types -y $cytokines -a $alpha -t $threshold -i $secretion_high -r $cell_radius -x $if_grid_spacing -w $window")
  iterations+=($iteration)
done
done
done
done
done
done
done
done
done
done

function do_run() {
  echo "PARAMS: $1"
  outdir="output-"$(echo $1 | tr -d '-' | tr ' ' '_')"-#$2"
  ./run $1 -q $outdir
  rm -rf $outdir
}
export -f do_run

results_dir=utils/results
rm -rf $results_dir
parallel -j 60 --results $results_dir --link do_run  ::: "${params_sets[@]}" ::: "${iterations[@]}" >/dev/null
