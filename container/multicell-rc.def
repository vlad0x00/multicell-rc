BootStrap: docker
From: ubuntu:20.04

%post
    export LC_ALL=C
    export MULTICELL_RC_VERSION=1.0.0
    export DEBIAN_FRONTEND=noninteractive
    # Necessary for tidyverse package
    export TZ='America/Vancouver'

    # Install the necessary packages
    apt-get -y update
    apt-get -y install python3 python3-venv libnuma1 libtbb2 r-base wkhtmltopdf imagemagick git wget zip libssl-dev curl libcurl4-openssl-dev libxml2-dev

    sed -i 's~<policy domain="coder" rights="none" pattern="PDF" />~<policy domain="coder" rights="read | write" pattern="PDF" />~' /etc/ImageMagick-6/policy.xml

    # Some Python packages are unavailable through apt-get, so we use pip for all of them
    python3 -m venv venv
    . venv/bin/activate
    pip3 install wheel
    pip3 install pyDOE numpy pandas scipy matplotlib seaborn networkx sklearn vtk
    
    # Install the necessary R packages
    Rscript -e 'install.packages(c("tidyverse", "stringi"))'
    
    # Obtain the multicell-rc code
    wget https://github.com/vlad0x00/multicell-rc/archive/refs/tags/v${MULTICELL_RC_VERSION}.zip
    unzip v${MULTICELL_RC_VERSION}.zip
    rm -f v${MULTICELL_RC_VERSION}.zip

    # Build the multicell-rc code
    cd multicell-rc-${MULTICELL_RC_VERSION}/model
    make
    cd ../..

%environment
    export LC_ALL=C
    export MULTICELL_RC_VERSION=1.0.0
    export DEBIAN_FRONTEND=noninteractive
    # Necessary for tidyverse package
    export TZ='America/Vancouver'

%runscript
    multicell-rc-${MULTICELL_RC_VERSION}/run

%labels
    Author Vladimir Nikolic
    Version 1.0.0
